<!DOCTYPE html>
<!-- Copyright 2017 Henry Heffan

This file is part of XC Scorer.

XC Scorer is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2.0 of the License, or
(at your option) any later version.

XC Scorer is distributed in the hope that it will be useful,
but without ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with XC Scorer.  If not, see <http://www.gnu.org/licenses/> -->
<html>
<!-- style.display="none""initial"-->
	
	<head>
		<meta charset="utf-8">
		<title>XC Scorer</title>
		<link rel="stylesheet" href="style.css">
		<link rel="stylesheet"
  media="only screen and (max-device-width: 4in)" href="style_phone.css">
		<meta name=viewport
			content="width=device-width, initial-scale=1.0, minimum-scale=0.5 maximum-scale=1.0, user-scalable=no">
	</head>
	<body>
		<div id="about_set" style="display:none" class="centered">
			<div style='text-align: left'>
				This site was created by Henry Heffan.
				<p>
				The source code for this site is <a href="https://github.com/HenryHef/XCScorer">here</a>.
				<p>
				This site (XC Scorer) is free software: you can redistribute it and/or modify
				it under the terms of the GNU General Public License as published by
				the Free Software Foundation, either version 2.0 of the License, or
				(at your option) any later version.
				<p>
				XC Scorer is distributed in the hope that it will be useful,
				but without ANY WARRANTY; without even the implied warranty of
				MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
				GNU General Public License for more details.
				<p>
				A copy of the GNU General Public License version 2.0 is provided along with the source code on <a href="https://github.com/HenryHef/XCScorer">github</a>. The licence can also be found at <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.
			</div>
			<input  type="button" value="Back" class="phonePaddingB" id="about_back"/>
			<p>
			Copyright 2017 Henry Heffan
		</div>
		<div id="xc_scoring_rules_set" style="display:none" class="centered">
			<div style='text-align: left'>
				Cross Country is scored based on the top seven runner on each team. Of those runner, the top 5 runners contribute to the team score, while the 6th and 7th runner displace runners on the other teams. All runners after the 7th runner are ignored.
				<p>
				In small meets, teams are scored against each other team individually. Therefore in tri and quad meets, they are treated like 2 and 3 dual meets respectivly. Each team is paired of with each team, and the places are consided as though only the tope 7 runners from each of those two teams ran. Then the palces of the first 5 runners on each team are added, and the lower score wins. I denote this "Pairwise Scoring."
				<p>
				Large meets are scored by considering the places of the top 5 runners on each team and adding thier positions. Once again, the lowest score wins. I denote this "Invitational Scoring."
				<p>
				In both kinds of scoring, in the case of a tie, the team with the faster 6th runner wins.
			</div>
			<input  type="button" value="Back" class="phonePaddingB" id="xc_scoring_rules_back"/>
		</div>
		<div class="centered" id="first_set">
			<div>
				<input type="button" value="How Scoring Works" class="phonePaddingB" id="xc_scoring_rules"> 
				<input type="button" value="About This Page" class="phonePaddingB" id="about">
			</div>
			<p>
			<div>
			Enter team names and assign colors.
			</div>
			<table id='teamsTab'>
				<tr>
					<td><input type="text" value="Brookline" class="nameI" id="ni1"></td>
					<td><div value="Team 1 Color" class="colorB box" id="cb1" style="background-color:yellow;color:black">Bro</div></td>
				</tr>
				<tr>
					<td><input type="text" value="Framingham" class="nameI" id="ni2"></td>
					<td><div value="Team 2 Color" class="colorB box" id="cb2" style="background-color:purple;color:white">Fra</div></td>
				</tr>
				<tr>
					<td><input type="text" value="Braintree" class="nameI" id="ni3"></td>
					<td><div value="Team 3 Color" class="colorB box" id="cb3" style="background-color:orange;color:black">Bra</div></td>
				</tr>
			</table>
			<p>
			
			<input type="button" value="+" class="addSubB" id="add">
			<input type="button" value="-" class="addSubB" id="sub">
			<p>
			<div>
			Choose a scoring method. If in "Pairwise Scoring" mode (used for dual-meets, tri-meets, quad-meets, etc.), the scores will be provided for each team against Team 1, so put the team you are focusing on in the first row.
			</div>
			<p>
			<div>
				<input type="button" value="Invitational Scoring" class="radiob" id="big_meetRB" style="background-color:#E2E2E2;font-weight:normal;">
				<input type="button" value="Pairwise Scoring" class="radiob" id="duel_meetRB" style="background-color:green;font-weight:bold;"> 
			</div>
			<p>
			<input type="button" value="Go Score!" id="done" class="phonePaddingB">
		</div>
		<div class="centered" id="secound_set" style="display: none">
			<input type="button" value="Start Again" class="phonePaddingB" id="reset">
			<div id="scoresDiv"></div>
			<div id="divBxs"></div>
			<div class="centered">
				<input type="button" value="Delete" id="del" class="phonePaddingB">
			</div>
			<p>
			<div class="centered bDiv" id="runnerBDiv">
				
				<input type="button" value="T1" class="runnerB" id="rb1">
				<input type="button" value="T2" class="runnerB" id="rb2">
				<input type="button" value="T3" class="runnerB" id="rb3">
			</div>
		</div>
		
	</body>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script type="text/javascript">
    //document.getElementById("myHeader").
    	const LIGHT_COLOR=0,DARK_COLOR=1;
		var posCList=
		[{color:"Gray",type:LIGHT_COLOR},
		{color:"Brown",type:LIGHT_COLOR},
		{color:"Red",type:LIGHT_COLOR},
		{color:"Orange",type:LIGHT_COLOR},
		{color:"Yellow",type:LIGHT_COLOR},
		{color:"Green",type:DARK_COLOR},
		{color:"Aqua",type:LIGHT_COLOR},
		{color:"Blue",type:DARK_COLOR},
		{color:"Purple",type:DARK_COLOR}];
		function TeamData(numI,cIndexInit) {
			this.num=numI;
			this.runnerB = document.getElementById('rb'+this.num);
			this.colorIndex=cIndexInit;
			this.colorB=document.getElementById('cb'+this.num);
			this.updateColorB();
			this.nameI=document.getElementById('ni'+this.num);

			var self=this;
			this.colorB.addEventListener('click',function() {
				self.incrementColorIndex();
				self.updateColorB();
			});
			self.colorB.innerHTML=self.getAbrv();
			this.nameI.addEventListener('input',function(){
				self.colorB.innerHTML=self.getAbrv();
			})
		}
		TeamData.prototype.getColor = function() {
			return posCList[this.colorIndex].color;
		};
		TeamData.prototype.getColorType = function() {
			return posCList[this.colorIndex].type;
		};
		TeamData.prototype.incrementColorIndex = function() {
			this.colorIndex++;
			this.colorIndex%=posCList.length;
		};
		TeamData.prototype.updateColorB = function() {
			this.colorB.style.backgroundColor=this.getColor();
			var textColor=(this.getColorType()===LIGHT_COLOR?"black":"white");
			this.colorB.style.color=textColor;
			
		};
		TeamData.prototype.getName=function(){
			return this.nameI.value;
		};
		TeamData.prototype.getAbrv=function(){
			return this.getName().substring(0, 3);
		}
		/*<p class="sc12"></p>*/
		/*
			var s = '<li>text</li>'; // HTML string

			var div = document.createElement('div');
			div.innerHTML = s;
			var elements = div.childNodes;
		*/

		/*set up code (LOAD and INIT Button Press Comands*/
		//var set_1=document.getElementById('first_set');
		var set_1=$('#first_set');
		var set_2=$('#secound_set');
		set_2.hide();

		var scoresDiv = document.getElementById('scoresDiv');
		var scoresPArray=[];

		var teams=[new TeamData(1,(4*1)%posCList.length),new TeamData(2,(4*2)%posCList.length),new TeamData(3,(4*3)%posCList.length)];

		var teamsTab=document.getElementById('teamsTab');

		var doneB=document.getElementById('done');
		var add=document.getElementById('add');
		var runnerBDiv=document.getElementById('runnerBDiv');
		add.addEventListener('click',function(item, index){
			var row = teamsTab.insertRow();
			$(row).hide();

			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);

			var i=teams.length+1;
			cell1.innerHTML="<input type=\"text\" value=\"New Team "+i+"\" class=\"nameI\" id=\"ni"+i+"\">";
			
			var i2 = document.createElement('div');
			//i2.type="button";
			i2.innerHTML="Tea";
			i2.className="colorB box";
			i2.id="cb"+i;
			cell2.appendChild(i2);
			row.focus();

			$(row).fadeIn(300);


			var i3 = document.createElement('input');
			i3.type="button";
			i3.value="T"+i;
			i3.className="runnerB";
			i3.id="rb"+i;
			runnerBDiv.appendChild(i3);

			team=new TeamData(i,(4*i)%posCList.length);
			teams.push(team);

			setUpTeam(team,teams.length-1);
			sub.disabled=false;
			//setUpTeam(teams[i-1],i)
		});
		var sub=document.getElementById('sub');
		sub.addEventListener('click',function(item, index){
			runnerBDiv.removeChild(teams[teams.length-1].runnerB);
			team=teams.pop();
			if(teams.length===2)
			{
				sub.disabled=true;
			}

			//teamsTab.deleteRow(teams.length-1);
			var here = this;
			$("#teamsTab tr:last").fadeOut(300,
				function(here){
					$(this).remove();
				});
		});
		var divBxs = document.getElementById('divBxs');
		var del=document.getElementById('del');

		var order=[];

		var isDuel=true;//false ==> is big meet
		var duelRB=document.getElementById('duel_meetRB');
		duelRB.style.backgroundColor="green";
		duelRB.style.fontWeight = "bold";
		var bigRB=document.getElementById('big_meetRB');
		bigRB.style.backgroundColor="#E2E2E2";
		bigRB.style.fontWeight = "normal";

		duelRB.addEventListener('click',function(){
			isDuel=true;
			duelRB.style.backgroundColor="green";
			duelRB.style.fontWeight = "bold";
			bigRB.style.backgroundColor="#E2E2E2";
			bigRB.style.fontWeight = "normal";
		});
		bigRB.addEventListener('click',function(){
			isDuel=false;
			duelRB.style.backgroundColor="#E2E2E2";
			duelRB.style.fontWeight = "normal";
			bigRB.style.backgroundColor="green";
			bigRB.style.fontWeight = "bold";
		});




		teams.forEach(function(item, index ) {
			setUpTeam(item,index);
		});
		doneB.addEventListener('click',function() {doneBClicked();
		});

		function setUpTeam(team,index)
		{
			team.runnerB.addEventListener('click',function() {
						teamBClicked(index+1);
					});
		}

		function doneBClicked() {
			$(set_1).fadeOut(300,function(){
				$(set_2).fadeIn(300);
			});
			inflateScoresFields();

			updateScores();
			for (i = 0; i < teams.length; i++) {
				teams[i].runnerB.style.color = teams[i].getColor();
				teams[i].runnerB.value = teams[i].getName();
			};
		};
		document.getElementById('reset').addEventListener('click',function() {
			$(set_2).fadeOut(300,function(){
				$(set_1).fadeIn(300);
				scoresPArray=[];
				order=[];
				while (scoresDiv.hasChildNodes()) {
				    scoresDiv.removeChild(scoresDiv.lastChild);
				}
				while (divBxs.hasChildNodes()) {
				    divBxs.removeChild(divBxs.lastChild);
				}
			});
		});

		document.getElementById('about').addEventListener('click',function() {
			$(set_1).fadeOut(300,function(){
				$('#about_set').fadeIn(300);
			});
		});
		document.getElementById('about_back').addEventListener('click',function() {
			$('#about_set').fadeOut(300,function(){
				$(set_1).fadeIn(300);
			});
		});
		document.getElementById('xc_scoring_rules').addEventListener('click',function() {
			$(set_1).fadeOut(300,function(){
				$('#xc_scoring_rules_set').fadeIn(300);
			});
		});
		document.getElementById('xc_scoring_rules_back').addEventListener('click',function() {
			$('#xc_scoring_rules_set').fadeOut(300,function(){
				$(set_1).fadeIn(300);
			});
		});

		function inflateScoresFields()
		{
			if(isDuel)
			{
				for (i = 1; i < teams.length; i++) {
					//scoresPArray[i-1]=scoreTextDuel(0,i);

					var newDiv = document.createElement('div');
					newDiv.style.margin="5px";
					var span1 = document.createElement('span');//team 1
					var span2 = document.createElement('span');// vs. 
					var span3 = document.createElement('span');//team 2
					var span4 = document.createElement('span');//score

					newDiv.appendChild(span1).focus();

					span1.style.color=teams[0].getColor();
					span1.className="fadable roundedBackground"
					span1.innerHTML=teams[0].getName();

					newDiv.appendChild(span2).focus();
					span2.innerHTML=" vs. ";

					newDiv.appendChild(span3).focus();
					span3.style.color=teams[i].getColor();
					span3.innerHTML=teams[i].getName();
					span3.className="fadable roundedBackground";

					newDiv.appendChild(span4).focus();
					span4.innerHTML=":    ";
					scoresPArray.push([span1,span2,span3,span4]);
					scoresDiv.appendChild(newDiv).focus();
				}
			}
			else//isBig
			{
				var newTab = document.createElement('table');
				scoresDiv.appendChild(newTab).focus();
				for (i = 0; i < teams.length; i++) {
					var row = newTab.insertRow();

					var cell1 = row.insertCell(0);
					var cell2 = row.insertCell(1);
					var cell3 = row.insertCell(2);

					cell1.innerHTML="1";

					cell2.innerHTML=teams[i].getName();
					cell2.style.color=teams[i].getColor();

					cell3.innerHTML="0+";

					scoresPArray.push([cell1,cell2,cell3]);
				}
			}
		}

		function teamBClicked(num) {
			order.push(num);
			updateScores();
			addColoredBox(teams[num-1].getColor(),teams[num-1].getAbrv(),teams[num-1].getColorType());
			$("#divBxs").scrollTop($("#divBxs")[0].scrollHeight);
			/*if(runnerCt(order,num)===7)
				teams[num-1].runnerB.disabled = true;*/
		}
		del.addEventListener('click',function(){
			//divBxs.lastChild.style.opacity = '0';
			id="box"+(order.length);
			$("#"+id).fadeOut(300, function() { $(this).remove();});
			//setTimeout(function(){removeTarget.parentNode.removeChild(removeTarget);}, 1000);
			order.pop();
			updateScores();
		})
		function updateScores()
		{
			if(isDuel)
			{
				for (i = 1; i < teams.length; i++) {
					d=formatScoreDuel(1,i+1);
					scoresPArray[i-1][3].innerHTML=":    "+d[0];
					winC= "#88FF88";
					lossC="#white";
					if(d[1])
					{
						scoresPArray[i-1][0].style.background=winC;
						scoresPArray[i-1][2].style.background=lossC;
					}
					else if(d[2])
					{
						scoresPArray[i-1][2].style.background=winC;
						scoresPArray[i-1][0].style.background=lossC;
					}
					else
					{
						scoresPArray[i-1][2].style.background="white";
						scoresPArray[i-1][0].style.background="white";
					}
				}
			}
			else//isBig
			{
				scoreData=scoreBig(order,teams.length);
				for(i=0;i< teams.length; i++)
				{
					scoresPArray[i][0].innerHTML=scoreData.get(i+1).place;
					scoresPArray[i][2].innerHTML=scoreData.get(i+1).scoreMin+(scoreData.get(i+1).scoreMin===scoreData.get(i+1).scoreMax?"":"+");
				}
			}
			
		}
		
		function runnerCt(places,num) {
			ct=0;
			places.forEach(function(item, index) {
				if(item===num)
					ct++;
			});
			return ct;
		}
		function formatScoreDuel(num1,num2)
		{
			sData=scoreDuel(order,num1,num2);
			
			a1=0;
			if(sData[4]===1)
				a1=-.0001
			a2=0
			if(sData[4]===2)
				a2=-.0001;
			sc1n=sData[0];
			sc1x=sData[1];
			m1=sc1n!==sc1x;
			sc2n=sData[2];
			sc2x=sData[3];
			m2=sc2n!==sc2x;

			re="";
			re += sc1n;
			if(m1===true)
				re+="+";
			re += ' , '+sc2n;
			if(m2===true)
				re+="+";

			w1=sc1x+a1<sc2n+a2;
			w2=sc2x+a2<sc1n+a1;
			return [re,w1,w2];
		}
		function scoreDuel(places,num1,num2) {
			sc1=0;
			sc2=0;
			ct1=0;
			ct2=0;
			tiebreaker=0;
			places.forEach(function(item, index) {
				if(ct1<7 && item===num1)
				{
					ct1+=1;
					if(ct1===6 && tiebreaker===0)
						tiebreaker=1;
					if(ct1<=5)
					{
						sc1+=(ct1+ct2);
					}
				}
				if(ct2<7 && item===num2)
				{
					ct2+=1;
					if(ct2===6 && tiebreaker===0)
						tiebreaker=2;
					if(ct2<=5)
					{
						sc2+=(ct1+ct2);
					}
				}
			});
			m1=ct1<5;
			m2=ct2<5;
			sc1Min=sc1;
			sc1Max=sc1;
			sc2Min=sc2;
			sc2Max=sc2;
			if(m1===true)
			{
				sc1Min+=(1+ct1+ct2+(4-ct1)/2.0)*(5-ct1);
				sc1Max+=(1+ct1+7+(4-ct1)/2.0)*(5-ct1);
			}
			if(m2===true)
			{
				sc2Min+=(1+ct1+ct2+(4-ct2)/2.0)*(5-ct2);
				sc2Max+=(1+7+ct2+(4-ct2)/2.0)*(5-ct2);
			}
			if(ct2===7)
				m1=false;
			if(ct1===7)
				m2=false;

			return [sc1Min,sc1Max,sc2Min,sc2Max,tiebreaker];
		}

		function scoreBig(places,numTeams) {
			var myMap = new Map();

			// setting the values
			//myMap.set(keyString, "value associated with 'a string'");
			//myMap.get(keyString);    // "value associated 
			for(i=1; i <numTeams+1; i++)
				myMap.set(i,{score:0,count:0,num6:-1});
			totCount=0;
			places.forEach(function(item, index) {
				if(myMap.get(item).count<7)
				{
					myMap.get(item).count++;
					totCount++;
					if(myMap.get(item).count<=5)
						myMap.get(item).score+=totCount;
					if(myMap.get(item).count===6)
						myMap.get(item).num6=totCount;
				}
			});
			for(i=1; i <numTeams+1; i++)
			{
				myMap.get(i).scoreMin=myMap.get(i).score;
				myMap.get(i).scoreMax=myMap.get(i).score;
				if(myMap.get(i).count<5)
				{
					myMap.get(i).scoreMin+=
					(1+totCount+(4-myMap.get(i).count)/2.0)*(5-myMap.get(i).count);
					myMap.get(i).scoreMax+=(1+myMap.get(i).count+7*(numTeams-1)+(4-myMap.get(i).count)/2.0)*(5-myMap.get(i).count);
				}
				/*allElseDone=true;
				for(j=0; j <numTeams; j++)
				{
					if(j!==i && myMap.get(item).count!==7)
					{
						allElseDone=false;
						break;
					}
				}*/
			}
			arr = [];
			for(i=1; i <numTeams+1; i++)
			{
				arr.push([]);
				n6=myMap.get(i).num6;
				if(n6==-1)
					n6=totCount+6-myMap.get(i).count;
				arr[i-1]=[i,myMap.get(i).scoreMin+n6*.0001];
			}

			arr.sort(function(a,b) {
			    return a[1]>b[1]? 1:a[1]<b[1]?-1:0;
			});
			for(i=0;i<arr.length; i++)
			{
				myMap.get(arr[i][0]).place=i+1;
			}

			return myMap;
		}
		function addColoredBox(boxColor,boxAbrv,cType)
		{
			var id="box"+order.length;
			var textColor=(cType===LIGHT_COLOR?"black":"white");
			var html = "<div class=\"box\" id=\""+id+"\" style=\"background:"+boxColor+";color:"+textColor+"\">"+boxAbrv+"</div>";
			$(html).hide().appendTo("#divBxs").fadeIn(600);
		}
	</script>
</html>
